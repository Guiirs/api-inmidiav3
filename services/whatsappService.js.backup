// services/whatsappService.js
const { Client, LocalAuth } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
const logger = require('../config/logger');
const Placa = require('../models/Placa');
const Aluguel = require('../models/Aluguel');

/**
 * Servi√ßo de integra√ß√£o com WhatsApp Web
 * Envia relat√≥rios di√°rios de disponibilidade de placas
 */
class WhatsAppService {
    constructor() {
        this.client = null;
        this.isReady = false;
        this.groupId = '120363425517091266@g.us'; // ID fixo como valor inicial de seguran√ßa
    }

    /**
     * Inicializa o cliente WhatsApp
     */
    async initialize() {
        try {
            logger.info('[WhatsApp] Inicializando cliente WhatsApp Web...');

            this.client = new Client({
                authStrategy: new LocalAuth({
                    dataPath: './whatsapp-session'
                }),
                puppeteer: {
                    headless: true,
                    args: [
                        '--no-sandbox',
                        '--disable-setuid-sandbox',
                        '--disable-dev-shm-usage',
                        '--disable-accelerated-2d-canvas',
                        '--no-first-run',
                        '--no-zygote',
                        '--disable-gpu'
                    ]
                }
            });

            // Evento: QR Code para autentica√ß√£o
            this.client.on('qr', (qr) => {
                logger.info('[WhatsApp] üì± QR Code gerado. Escaneie com seu WhatsApp:');
                console.log('\n========================================');
                qrcode.generate(qr, { small: true });
                console.log('========================================\n');
                logger.info('[WhatsApp] Aguardando leitura do QR Code...');
            });

            // Evento: Cliente autenticado
            this.client.on('authenticated', () => {
                logger.info('[WhatsApp] ‚úÖ Cliente autenticado com sucesso!');
            });

            // Evento: Cliente pronto
            this.client.on('ready', async () => {
                this.isReady = true;
                logger.info('[WhatsApp] üöÄ Cliente WhatsApp pronto para enviar mensagens!');
                
                // Busca o grupo configurado em background com timeout
                setTimeout(async () => {
                    try {
                        await this.findGroup();
                    } catch (error) {
                        logger.error(`[WhatsApp] Erro ao buscar grupo: ${error.message}`);
                    }
                }, 1000); // Aguarda 1 segundo antes de buscar grupos
            });

            // Evento: Mensagem recebida (para comandos)
            this.client.on('message', async (message) => {
                await this.handleMessage(message);
            });

            // Evento: Desconex√£o
            this.client.on('disconnected', (reason) => {
                this.isReady = false;
                logger.warn(`[WhatsApp] ‚ö†Ô∏è Cliente desconectado: ${reason}`);
            });

            // Evento: Erro de autentica√ß√£o
            this.client.on('auth_failure', (msg) => {
                logger.error(`[WhatsApp] ‚ùå Falha na autentica√ß√£o: ${msg}`);
            });

            // Inicializa o cliente
            await this.client.initialize();

        } catch (error) {
            logger.error(`[WhatsApp] Erro ao inicializar: ${error.message}`);
            throw error;
        }
    }

    /**
     * Busca o grupo pelo nome ou usa o primeiro grupo encontrado
     */
    async findGroup() {
        try {
            const NOME_GRUPO = process.env.WHATSAPP_GROUP_NAME || 'Placas Dispon√≠veis';
            const GROUP_ID_FALLBACK = '120363425517091266@g.us'; // ID fixo como seguran√ßa
            
            const chats = await this.client.getChats();
            const groups = chats.filter(chat => chat.isGroup);

            logger.info(`[WhatsApp] Encontrados ${groups.length} grupos`);

            // Tenta encontrar o grupo pelo nome
            const targetGroup = groups.find(group => 
                group.name.toLowerCase().includes(NOME_GRUPO.toLowerCase())
            );

            if (targetGroup) {
                this.groupId = targetGroup.id._serialized;
                logger.info(`[WhatsApp] ‚úÖ Grupo encontrado por nome: "${targetGroup.name}" (${this.groupId})`);
            } else {
                // Se n√£o encontrar pelo nome, usa o ID fixo como seguran√ßa
                logger.warn(`[WhatsApp] ‚ö†Ô∏è Grupo "${NOME_GRUPO}" n√£o encontrado por nome.`);
                logger.info(`[WhatsApp] üîí Usando ID fixo de seguran√ßa: ${GROUP_ID_FALLBACK}`);
                this.groupId = GROUP_ID_FALLBACK;
                
                // Verifica se o grupo com ID fixo existe
                const groupById = groups.find(g => g.id._serialized === GROUP_ID_FALLBACK);
                if (groupById) {
                    logger.info(`[WhatsApp] ‚úÖ Grupo verificado: "${groupById.name}"`);
                } else {
                    logger.warn(`[WhatsApp] ‚ö†Ô∏è ID fixo n√£o encontrado nos grupos dispon√≠veis`);
                }
            }
        } catch (error) {
            logger.error(`[WhatsApp] Erro ao buscar grupo: ${error.message}`);
            // Em caso de erro, usa o ID fixo como √∫ltimo recurso
            this.groupId = '120363425517091266@g.us';
            logger.info(`[WhatsApp] üîí Usando ID fixo de emerg√™ncia`);
        }
    }

    /**
     * Trata mensagens recebidas (comandos)
     */
    async handleMessage(message) {
        try {
            const body = message.body.toLowerCase().trim();
            
            // Ignora mensagens vazias ou que n√£o s√£o comandos
            if (!body.startsWith('!')) return;
            
            logger.info(`[WhatsApp] üì© Comando recebido: "${body}"`);
            
            // Comando: !placas
            if (body === '!placas' || body === '!disponibilidade') {
                logger.info(`[WhatsApp] Verificando permiss√µes do usu√°rio...`);
                const isAdmin = await this.isUserAdmin(message);
                
                if (!isAdmin) {
                    logger.warn(`[WhatsApp] Usu√°rio sem permiss√£o de admin`);
                    await message.reply('‚ö†Ô∏è Apenas administradores podem solicitar o relat√≥rio.');
                    return;
                }

                logger.info(`[WhatsApp] Enviando confirma√ß√£o...`);
                await message.reply('üîÑ Gerando relat√≥rio de disponibilidade...');
                
                logger.info(`[WhatsApp] Gerando e enviando relat√≥rio...`);
                const sucesso = await this.enviarRelatorioDisponibilidade(message.from);
                
                if (sucesso) {
                    logger.info(`[WhatsApp] ‚úÖ Relat√≥rio enviado com sucesso!`);
                } else {
                    logger.error(`[WhatsApp] ‚ùå Falha ao enviar relat√≥rio`);
                    await message.reply('‚ùå Erro ao gerar relat√≥rio. Tente novamente.');
                }
            }
            
            // Comando: !help
            else if (body === '!help' || body === '!ajuda') {
                logger.info(`[WhatsApp] Enviando ajuda...`);
                const helpText = `
üìã *Comandos Dispon√≠veis:*

!placas - Exibe relat√≥rio de disponibilidade
!disponibilidade - Alias para !placas
!help - Mostra esta ajuda

üí° O relat√≥rio di√°rio √© enviado automaticamente todos os dias √†s ${process.env.WHATSAPP_REPORT_HOUR || '09:00'}h
                `.trim();
                
                await message.reply(helpText);
                logger.info(`[WhatsApp] ‚úÖ Ajuda enviada`);
            }
        } catch (error) {
            logger.error(`[WhatsApp] Erro ao processar mensagem: ${error.message}`);
            console.error(error);
            try {
                await message.reply('‚ùå Erro ao processar comando. Tente novamente.');
            } catch (replyError) {
                logger.error(`[WhatsApp] Erro ao enviar mensagem de erro: ${replyError.message}`);
            }
        }
    }

    /**
     * Verifica se usu√°rio √© admin do grupo
     */
    async isUserAdmin(message) {
        try {
            const chat = await message.getChat();
            if (!chat.isGroup) return true; // Mensagens privadas sempre permitidas
            
            // Busca o participante pelo ID do autor da mensagem
            const authorId = message.author || message.from;
            const participant = chat.participants.find(p => p.id._serialized === authorId);
            
            if (!participant) {
                logger.warn(`[WhatsApp] Participante n√£o encontrado para verificar permiss√£o`);
                return true; // Permite por padr√£o se n√£o conseguir verificar
            }
            
            return participant.isAdmin || participant.isSuperAdmin;
        } catch (error) {
            logger.error(`[WhatsApp] Erro ao verificar admin: ${error.message}`);
            return true; // Permite por padr√£o em caso de erro
        }
    }

    /**
     * Gera relat√≥rio de disponibilidade de placas
     */
    async gerarRelatorio(empresaId = null) {
        try {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            logger.info('[WhatsApp] Gerando relat√≥rio de disponibilidade...');

            // Busca todas as placas
            const query = empresaId ? { empresa: empresaId } : {};
            const placas = await Placa.find(query)
                .populate('regiao', 'nome')
                .sort({ numero_placa: 1 })
                .lean();

            logger.info(`[WhatsApp] Encontradas ${placas.length} placas no total`);

            // Busca alugu√©is ativos hoje
            const alugueisAtivos = await Aluguel.find({
                ...(empresaId && { empresa: empresaId }),
                data_inicio: { $lte: hoje },
                data_fim: { $gte: hoje }
            })
            .populate('placa', '_id numero_placa')
            .populate('cliente', 'nome')
            .lean();

            logger.info(`[WhatsApp] Encontrados ${alugueisAtivos.length} alugu√©is ativos`);

            // Mapeia placas alugadas com seus detalhes
            const placasAlugadasMap = new Map();
            
            alugueisAtivos.forEach(aluguel => {
                if (aluguel.placa) {
                    const placaId = typeof aluguel.placa === 'object' 
                        ? aluguel.placa._id.toString() 
                        : aluguel.placa.toString();
                    
                    placasAlugadasMap.set(placaId, {
                        cliente: aluguel.cliente?.nome || 'Cliente Desconhecido',
                        data_inicio: aluguel.data_inicio,
                        data_fim: aluguel.data_fim
                    });
                }
            });

            // Separa placas por status
            const disponiveisSemAluguel = [];
            const alugadas = [];
            const indisponiveis = [];

            placas.forEach(placa => {
                const placaId = placa._id.toString();
                const infoAluguel = placasAlugadasMap.get(placaId);

                if (infoAluguel) {
                    // Placa est√° alugada
                    alugadas.push({
                        ...placa,
                        cliente: infoAluguel.cliente,
                        data_inicio: infoAluguel.data_inicio,
                        data_fim: infoAluguel.data_fim
                    });
                } else if (placa.disponivel === false) {
                    // Placa marcada como indispon√≠vel
                    indisponiveis.push(placa);
                } else {
                    // Placa dispon√≠vel para aluguel
                    disponiveisSemAluguel.push(placa);
                }
            });

            logger.info(`[WhatsApp] Separadas: ${disponiveisSemAluguel.length} dispon√≠veis, ${alugadas.length} alugadas, ${indisponiveis.length} indispon√≠veis`);

            return {
                total: placas.length,
                disponiveis: disponiveisSemAluguel,
                alugadas,
                indisponiveis,
                data: hoje
            };
        } catch (error) {
            logger.error(`[WhatsApp] Erro ao gerar relat√≥rio: ${error.message}`);
            console.error(error);
            throw error;
        }
    }

    /**
     * Formata relat√≥rio para WhatsApp
     */
    formatarMensagem(relatorio) {
        const { total, disponiveis, alugadas, indisponiveis, data } = relatorio;
        
        const dataHoraFormatada = new Date().toLocaleString('pt-PT', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        let mensagem = `üìä *RELAT√ìRIO DE DISPONIBILIDADE*\n`;
        mensagem += `_Atualizado em ${dataHoraFormatada}_\n\n`;

        // Resumo
        mensagem += `üìà *RESUMO GERAL*\n`;
        mensagem += `‚Ä¢ Total de Placas: ${total}\n`;
        mensagem += `‚Ä¢ Dispon√≠veis: ‚úÖ ${disponiveis.length}\n`;
        mensagem += `‚Ä¢ Alugadas: üü° ${alugadas.length}\n`;
        mensagem += `‚Ä¢ Indispon√≠veis: ‚ùå ${indisponiveis.length}\n\n`;

        // Placas Dispon√≠veis
        if (disponiveis.length > 0) {
            mensagem += `‚úÖ *PLACAS DISPON√çVEIS (${disponiveis.length})*\n`;
            
            // Limitar a 30 placas para n√£o ficar muito grande
            const limite = Math.min(disponiveis.length, 30);
            
            for (let i = 0; i < limite; i++) {
                const placa = disponiveis[i];
                const regiao = placa.regiao?.nome || 'Sem regi√£o';
                const rua = placa.nomeDaRua ? ` - ${placa.nomeDaRua}` : '';
                mensagem += `  ‚Ä¢ ${placa.numero_placa} - ${regiao}${rua}\n`;
            }
            
            if (disponiveis.length > limite) {
                mensagem += `  ... e mais ${disponiveis.length - limite} placas\n`;
            }
            mensagem += `\n`;
        }

        // Placas Alugadas
        if (alugadas.length > 0) {
            mensagem += `ÔøΩ *PLACAS ALUGADAS (${alugadas.length})*\n`;
            
            alugadas.forEach(placa => {
                const regiao = placa.regiao?.nome || 'Sem regi√£o';
                const rua = placa.nomeDaRua ? ` - ${placa.nomeDaRua}` : '';
                const dataFim = new Date(placa.data_fim).toLocaleDateString('pt-PT');
                mensagem += `  ‚Ä¢ ${placa.numero_placa} - ${regiao}${rua}\n`;
                mensagem += `    üë§ ${placa.cliente} | üìÖ At√©: ${dataFim}\n`;
            });
            mensagem += `\n`;
        }

        // Placas Indispon√≠veis
        if (indisponiveis.length > 0) {
            mensagem += `‚ùå *PLACAS INDISPON√çVEIS (${indisponiveis.length})*\n`;
            
            indisponiveis.forEach(placa => {
                const regiao = placa.regiao?.nome || 'Sem regi√£o';
                const rua = placa.nomeDaRua ? ` - ${placa.nomeDaRua}` : '';
                mensagem += `  ‚Ä¢ ${placa.numero_placa} - ${regiao}${rua}\n`;
            });
            mensagem += `\n`;
        }

        mensagem += `_Sistema de Gest√£o de Placas_`;

        return mensagem;
    }

    /**
     * Envia relat√≥rio de disponibilidade
     */
    async enviarRelatorioDisponibilidade(chatId = null) {
        try {
            if (!this.isReady) {
                logger.warn('[WhatsApp] Cliente n√£o est√° pronto. Ignorando envio.');
                return false;
            }

            const targetChatId = chatId || this.groupId;
            
            // Se n√£o tiver groupId configurado, tenta buscar novamente
            if (!targetChatId) {
                logger.warn('[WhatsApp] Grupo n√£o configurado. Tentando buscar...');
                await this.findGroup();
                
                if (!this.groupId) {
                    logger.error('[WhatsApp] Nenhum chat/grupo configurado para envio.');
                    return false;
                }
            }

            const finalChatId = chatId || this.groupId;
            logger.info(`[WhatsApp] Gerando relat√≥rio de disponibilidade...`);
            
            // Gera relat√≥rio
            const relatorio = await this.gerarRelatorio();
            const mensagem = this.formatarMensagem(relatorio);

            // Envia mensagem
            await this.client.sendMessage(finalChatId, mensagem);
            
            logger.info(`[WhatsApp] ‚úÖ Relat√≥rio enviado com sucesso para ${finalChatId}`);
            return true;

        } catch (error) {
            logger.error(`[WhatsApp] Erro ao enviar relat√≥rio: ${error.message}`);
            return false;
        }
    }

    /**
     * Envia mensagem customizada
     */
    async enviarMensagem(mensagem, chatId = null) {
        try {
            if (!this.isReady) {
                logger.warn('[WhatsApp] Cliente n√£o est√° pronto.');
                return false;
            }

            const targetChatId = chatId || this.groupId;
            
            if (!targetChatId) {
                logger.error('[WhatsApp] Nenhum chat configurado.');
                return false;
            }

            await this.client.sendMessage(targetChatId, mensagem);
            logger.info(`[WhatsApp] Mensagem enviada: ${mensagem.substring(0, 50)}...`);
            return true;

        } catch (error) {
            logger.error(`[WhatsApp] Erro ao enviar mensagem: ${error.message}`);
            return false;
        }
    }

    /**
     * Destroi o cliente
     */
    async destroy() {
        if (this.client) {
            await this.client.destroy();
            this.isReady = false;
            logger.info('[WhatsApp] Cliente destru√≠do');
        }
    }
}

// Exporta singleton
module.exports = new WhatsAppService();
